alertmanager:
  enabled: true

  config:
    global:
      resolve_timeout: 5m

    route:
      group_by: ['namespace', 'alertname']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 1h
      receiver: 'telegram-notifications'

      routes:
        - receiver: 'telegram-critical'
          matchers:
            - severity =~ "critical|error"
          repeat_interval: 5m

        - receiver: 'telegram-warning'
          matchers:
            - severity =~ "warning"
          repeat_interval: 30m

        - receiver: 'null'
          matchers:
            - alertname = "Watchdog"

    receivers:
      - name: 'telegram-notifications'
        telegram_configs:
          - bot_token: '8569699896:AAH7oO91jt9i1F-63P5CUfq1RZ1U7VKnsZc'
            chat_id: -1003410212815
            parse_mode: 'HTML'
            message: |
              ğŸŒ <b>ALERT FIRED</b>

              {{ range .Alerts }}
              ğŸ”” <b>{{ .Annotations.summary }}</b>

              ğŸ“ <b>Description:</b> {{ .Annotations.description }}
              ğŸ“Š <b>Status:</b> {{ .Status }}

              <b>ğŸ· Labels:</b>
              {{ range .Labels.SortedPairs }}
              â€¢ <code>{{ .Name }}={{ .Value }}</code>
              {{ end }}

              {{ end }}
            send_resolved: true

      - name: 'telegram-critical'
        telegram_configs:
          - bot_token: '8569699896:AAH7oO91jt9i1F-63P5CUfq1RZ1U7VKnsZc'
            chat_id: -1003410212815
            parse_mode: 'HTML'
            message: |
              ğŸš¨ <b><u>CRITICAL ALERT</u></b> ğŸš¨

              {{ range .Alerts }}
              ğŸ”¥ <b>{{ .Annotations.summary }}</b>

              ğŸ“› <b>Description:</b> <i>{{ .Annotations.description }}</i>
              ğŸ§© <b>Cluster:</b> {{ or .Labels.cluster "unknown" }}
              ğŸ“¦ <b>Namespace:</b> {{ or .Labels.namespace "unknown" }}
              âš™ï¸ <b>Service:</b> {{ or .Labels.service (or .Labels.job "unknown") }}

              <b>ğŸ· Labels:</b>
              {{ range .Labels.SortedPairs }}
              â€¢ <code>{{ .Name }}={{ .Value }}</code>
              {{ end }}

              {{ end }}
            send_resolved: true

      - name: 'telegram-warning'
        telegram_configs:
          - bot_token: '8569699896:AAH7oO91jt9i1F-63P5CUfq1RZ1U7VKnsZc'
            chat_id: -1003410212815
            parse_mode: 'HTML'
            message: |
              âš ï¸ <b>WARNING ALERT</b>

              {{ range .Alerts }}
              âš ï¸ <b>{{ .Annotations.summary }}</b>
              ğŸ“ <b>Description:</b> {{ .Annotations.description }}

              <b>ğŸ· Labels:</b>
              {{ range .Labels.SortedPairs }}
              â€¢ <code>{{ .Name }}={{ .Value }}</code>
              {{ end }}

              {{ end }}
            send_resolved: true

      - name: 'null'

    inhibit_rules:
      - source_matchers:
          - 'severity = critical'
        target_matchers:
          - 'severity =~ warning|info'
        equal: ['namespace', 'alertname']

      - source_matchers:
          - 'severity = warning'
        target_matchers:
          - 'severity = info'
        equal: ['namespace', 'alertname']


prometheus:
  prometheusSpec:
    hostNetwork: true
    dnsPolicy: ClusterFirstWithHostNet

    tolerations:
      - key: "node-role.kubernetes.io/control-plane"
        operator: "Exists"
        effect: "NoSchedule"

    nodeSelector:
      node-role.kubernetes.io/control-plane: ""

    secrets:
      - kube-controlplane-metrics-certs
      - prometheus-additional-scrape-configs

    additionalScrapeConfigsSecret:
      enabled: true
      name: prometheus-additional-scrape-configs
      key: secret.yaml


kubeEtcd:
  serviceMonitor:
    enabled: false

kubeControllerManager:
  serviceMonitor:
    enabled: false

kubeScheduler:
  serviceMonitor:
    enabled: false

kubeProxy:
  serviceMonitor:
    enabled: false
