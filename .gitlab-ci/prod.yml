workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE != "merge_request_event"'
      when: never
    - when: always

stages:
  - promote_stage
  - promote_prod
  - build
  - update-manifests

promote_to_prod:
  stage: promote_prod
  when: manual
  allow_failure: false
  tags: [test]
  image: alpine:latest

  before_script:
    - apk add --no-cache git curl bash
    - curl -s https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh | bash
    - mv kustomize /usr/local/bin/
    - git config --global user.email "ci@gitlab.com"
    - git config --global user.name "GitLab CI"

  script:
      - 'git clone --branch k8s-manifests "https://oauth2:${GITLAB_TOKEN}@gitlab.com/solodium191/homelab-go.git" manifests'
      - 'cd manifests'
      - 'VOTE_PROD=$(grep -A2 "name: .*vote" k8s/overlays/stage/kustomization.yaml | grep newTag | awk "{print \$2}")'
      - 'RESULT_PROD=$(grep -A2 "name: .*result" k8s/overlays/stage/kustomization.yaml | grep newTag | awk "{print \$2}")'
      - 'WORKER_PROD=$(grep -A2 "name: .*worker" k8s/overlays/stage/kustomization.yaml | grep newTag | awk "{print \$2}")'
      - 'echo "Vote tag: $VOTE_PROD"'
      - 'echo "Result tag: $RESULT_PROD"'
      - 'echo "Worker tag: $WORKER_PROD"'
      - 'cd k8s/overlays/prod'
      - 'kustomize edit set image registry.gitlab.com/solodium191/homelab-go/vote=registry.gitlab.com/solodium191/homelab-go/vote:${VOTE_PROD}'
      - 'kustomize edit set image registry.gitlab.com/solodium191/homelab-go/result=registry.gitlab.com/solodium191/homelab-go/result:${RESULT_PROD}'
      - 'kustomize edit set image registry.gitlab.com/solodium191/homelab-go/worker=registry.gitlab.com/solodium191/homelab-go/worker:${WORKER_PROD}'
      - 'cd ../../..'
      - 'git add k8s/overlays/prod/kustomization.yaml'
      - 'git commit -m "Sync images from develop â†’ stage" || echo "Nothing to commit"'
      - 'git push origin k8s-manifests'